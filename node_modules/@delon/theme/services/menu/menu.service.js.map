{"version":3,"file":"menu.service.js","sourceRoot":"","sources":["../../../../.ng_build/theme/services/menu/menu.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional, OnDestroy } from '@angular/core';\nimport { Observable } from 'rxjs/Observable';\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\nimport { share } from 'rxjs/operators';\nimport { ALAIN_I18N_TOKEN, AlainI18NService } from '../i18n/i18n';\n\nexport interface Menu {\n    /** 文本 */\n    text: string;\n    /** i18n主键 */\n    i18n?: string;\n    /** 是否菜单组 */\n    group?: boolean;\n    /** angular 路由 */\n    link?: string;\n    /** 外部链接 */\n    externalLink?: string;\n    /** 链接 target */\n    target?: '_blank' | '_self' | '_parent' | '_top';\n    /** 图标 */\n    icon?: string;\n    /** 徽标数，展示的数字。（注：`group:true` 无效） */\n    badge?: number;\n    /** 徽标数，显示小红点 */\n    badge_dot?: boolean;\n    /** 徽标数，设置 Badge 颜色 （默认：error， 所有颜色值见：https://github.com/cipchk/ng-alain/blob/master/_documents/utils.md#色彩） */\n    badge_status?: string;\n    /** 是否隐藏 */\n    hide?: boolean;\n    /** ACL配置 */\n    acl?: any;\n    /** 是否快捷菜单项 */\n    shortcut?: boolean;\n    /** 快捷菜单根节点 */\n    shortcut_root?: boolean;\n    /** 是否允许复用，需配合 `reuse-tab` 组件 */\n    reuse?: boolean;\n    /** 二级菜单 */\n    children?: Menu[];\n    /**\n     * 菜单类型，无须指定由 Service 自动识别\n     * 1：链接\n     * 2：外部链接\n     * 3：链接（子菜单）\n     * @private\n     */\n    _type?: number;\n    /**\n     * 是否选中\n     * @private\n     */\n    _selected?: boolean;\n    /**\n     * 是否打开\n     * @private\n     */\n    _open?: boolean;\n    /**\n     * @private\n     */\n    _depth?: number;\n\n    [key: string]: any;\n}\n\n@Injectable()\nexport class MenuService implements OnDestroy {\n\n    private _change$: BehaviorSubject<Menu[]> = new BehaviorSubject<Menu[]>([]);\n\n    private data: Menu[] = [];\n\n    constructor(@Optional() @Inject(ALAIN_I18N_TOKEN) private i18nService: AlainI18NService) { }\n\n    get change(): Observable<Menu[]> {\n        return this._change$.pipe(share());\n    }\n\n    visit(callback: (item: Menu, parentMenum: Menu, depth?: number) => void) {\n        const inFn = (list: Menu[], parentMenu: Menu, depth: number) => {\n            for (const item of list) {\n                callback(item, parentMenu, depth);\n                if (item.children && item.children.length > 0) {\n                    inFn(item.children, item, depth + 1);\n                } else {\n                    item.children = [];\n                }\n            }\n        };\n\n        inFn(this.data, null, 0);\n    }\n\n    add(items: Menu[]) {\n        this.data.push(...items);\n        this.resume();\n    }\n\n    /**\n     * 重置菜单，可能I18N、用户权限变动时需要调用刷新\n     */\n    resume(callback?: (item: Menu, parentMenum: Menu, depth?: number) => void) {\n        let i = 1;\n        this.removeShortcut();\n        const shortcuts: Menu[] = [];\n        this.visit((item, parent, depth) => {\n            item.__id = i++;\n            item.__parent = parent;\n            item._depth = depth;\n\n            if (!item.link) item.link = '';\n            if (!item.externalLink) item.externalLink = '';\n\n            // badge\n            if (item.badge) {\n                if (item.badge_dot !== true) {\n                    item.badge_dot = false;\n                }\n                if (!item.badge_status) {\n                    item.badge_status = 'error';\n                }\n            }\n\n            item._type = item.externalLink ? 2 : 1;\n            if (item.children && item.children.length > 0) {\n                item._type = 3;\n            }\n\n            // shortcut\n            if (item.shortcut === true && (item.link || item.externalLink))\n                shortcuts.push(item);\n\n            const i18n = item.i18n || item.translate;\n            item.text = this.i18nService && i18n ? this.i18nService.fanyi(i18n) : item.text;\n\n            if (callback) callback(item, parent, depth);\n        });\n\n        this.loadShortcut(shortcuts);\n        this._change$.next(this.data);\n    }\n\n    /**\n     * 加载快捷菜单，加载位置规则如下：\n     * 1、统一在下标0的节点下（即【主导航】节点下方）\n     *      1、若 children 存在 【shortcut_root: true】则最优先【推荐】这种方式\n     *      2、否则查找带有【dashboard】字样链接，若存在则在此菜单的下方创建快捷入口\n     *      3、否则放在0节点位置\n     */\n    private loadShortcut(shortcuts: Menu[]) {\n        if (shortcuts.length === 0 || this.data.length === 0) return;\n\n        const ls = this.data[0].children || [];\n        let pos = ls.findIndex(w => w.shortcut_root === true);\n        if (pos === -1) {\n            pos = ls.findIndex(w => w.link.includes('dashboard') || w.externalLink.includes('dashboard'));\n            pos = (pos !== -1 ? pos : -1) + 1;\n            this.data[0].children.splice(pos, 0, {\n                text: '快捷菜单',\n                translate: 'shortcut',\n                icon: 'icon-rocket',\n                children: []\n            });\n        }\n        let _data = this.data[0].children[pos];\n        _data = Object.assign(_data, {\n            shortcut_root: true,\n            _type: 3,\n            __id: -1,\n            _depth: 1\n        });\n        _data.children = shortcuts.map(i => {\n            i._depth = 2;\n            return i;\n        });\n    }\n\n    private removeShortcut() {\n        const ls = this.data[0].children || [];\n        const pos = ls.findIndex(w => w.shortcut_root === true);\n        if (pos !== -1) ls.splice(pos, 1);\n    }\n\n    get menus() {\n        return this.data;\n    }\n\n    /**\n     * 清空菜单\n     */\n    clear() {\n        this.data = [];\n        this._change$.next(this.data);\n    }\n\n    /**\n     * 根据URL设置菜单 `_open` 属性\n     * @param url URL地址\n     */\n    openedByUrl(url: string) {\n        if (!url) {\n            return;\n        }\n\n        let findItem: Menu = null;\n        this.visit(item => {\n            item._open = false;\n            if (!item.link) {\n                return;\n            }\n            if (!findItem && url.startsWith(item.link)) {\n                findItem = item;\n            }\n        });\n        if (!findItem) {\n            console.warn(`not found page name: ${url}`);\n            return;\n        }\n\n        do {\n            findItem._open = true;\n            findItem = findItem.__parent;\n        } while (findItem);\n    }\n\n    /**\n     * 根据url获取菜单列表\n     * @param url\n     */\n    getPathByUrl(url: string): Menu[] {\n        let item: Menu = null;\n        this.visit((i, parent, depth) => {\n            if (i.link === url) {\n                item = i;\n            }\n        });\n\n        const ret: Menu[] = [];\n        if (!item) return ret;\n\n        do {\n            ret.splice(0, 0, item);\n            item = item.__parent;\n        } while (item);\n\n        return ret;\n    }\n\n    ngOnDestroy(): void {\n        if (this._change$) this._change$.unsubscribe();\n    }\n}\n"]}