{"version":3,"file":"timeline.component.js","sourceRoot":"","sources":["../../../../.ng_build/abc/charts/timeline/timeline.component.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,SAAS,EAAE,KAAK,EAAe,SAAS,EAAE,UAAU,EAAuD,WAAW,EAAgB,uBAAuB,EAAE,iBAAiB,EAAE,MAAM,eAAe,CAAC;AACjN,OAAO,EAAE,oBAAoB,EAAE,MAAM,uBAAuB,CAAC;;IAsDzD,2BAAoB,EAAqB;QAArB,OAAE,GAAF,EAAE,CAAmB;;sBAvChC,EAAE;wBAYsC,EAAE,EAAE,EAAE,SAAS,EAAE,EAAE,EAAE,SAAS,EAAE;uBAO/D,GAAG;uBAEQ,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,CAAC;4BAOtB,CAAC;wBAQb,KAAK;KAG8B;0BApC1C,oCAAK;uBAAC,KAAgC;YACtC,EAAE,CAAC,CAAC,KAAK,YAAY,WAAW,CAAC;gBAC7B,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YAC3B,IAAI;gBACA,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;;;;;0BAQxB,qCAAM;2BAAK,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC;aACnC,UAAW,KAAU;YACjB,IAAI,CAAC,OAAO,GAAG,oBAAoB,CAAC,KAAK,CAAC,CAAC;SAC9C;;;;0BAMG,0CAAW;2BAAK,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC;aAC7C,UAAgB,KAAU;YACtB,IAAI,CAAC,YAAY,GAAG,oBAAoB,CAAC,KAAK,CAAC,CAAC;SACnD;;;;IAcD,oCAAQ,GAAR;QAAA,iBAGC;QAFG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,UAAU,CAAC,cAAM,OAAA,KAAI,CAAC,OAAO,EAAE,EAAd,CAAc,EAAE,GAAG,CAAC,CAAC;KACzC;IAED,mCAAO,GAAP;QACI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YAAC,MAAM,CAAC;;QAG9D,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,SAAS,GAAG,EAAE,CAAC;QAC7C,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,SAAS,GAAG,EAAE,CAAC;QAEvC,IAAM,GAAG,GAAG,CAAC,CAAC;QACd,IAAM,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAExE,IAAM,EAAE,GAAG,IAAI,OAAO,CAAC;YACnB,KAAK,EAAE;gBACH,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC;gBAC7B,GAAG,EAAE,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;aACpC;SACJ,CAAC,CAAC;QACH,IAAM,EAAE,GAAG,EAAE,CAAC,UAAU,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC7C,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,SAAS,CAAC;YAC3B,IAAI,EAAE,QAAQ;YACd,QAAQ,YAAC,GAAG;gBACR,IAAM,IAAI,GAAG,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC;gBACvC,MAAM,CAAC,IAAI,IAAI,EAAE,CAAC,KAAK,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC;aACzD;SACJ,CAAC,CAAC;QAEH,IAAM,KAAK,GAAG,IAAI,EAAE,CAAC,KAAK,CAAC;YACvB,SAAS,EAAE,IAAI,CAAC,IAAI,CAAC,aAAa;YAClC,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM;YACpB,OAAO,EAAE,IAAI,CAAC,OAAO;SACxB,CAAC,CAAC;QACH,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;QAClC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE;YACb,KAAK,EAAE,KAAK;SACf,CAAC,CAAC;QACH,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QAExB,IAAI,GAAG,CAAC;QACR,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YACrD,GAAG,GAAG,IAAI,CAAC,GAAG,CACV,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,UAAC,CAAC,EAAE,CAAC,IAAK,OAAA,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,EAAE,EAAX,CAAW,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,EAC3C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,UAAC,CAAC,EAAE,CAAC,IAAK,OAAA,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,EAAE,EAAX,CAAW,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAC9C,CAAC;SACL;QACD,KAAK,CAAC,MAAM,CAAC,EAAE,EAAE;YACb,CAAC,EAAE;gBACC,IAAI,EAAE,SAAS;gBACf,SAAS,EAAE,GAAG;gBACd,IAAI,EAAE,OAAO;gBACb,KAAK,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;aAChB;YACD,EAAE,EAAE;gBACA,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE;gBACvB,GAAG,KAAA;gBACH,GAAG,EAAE,CAAC;aACT;YACD,EAAE,EAAE;gBACA,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE;gBACvB,GAAG,KAAA;gBACH,GAAG,EAAE,CAAC;aACT;SACJ,CAAC,CAAC;QAEH,KAAK,CAAC,MAAM,CAAC;YACT,QAAQ,EAAE,KAAK;YACf,MAAM,EAAE,IAAI;YACZ,SAAS,EAAE,KAAK;YAChB,KAAK,EAAE;gBACH,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE;gBACnD,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE;aACtD;SACJ,CAAC,CAAC;QAEH,KAAK,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC7E,KAAK,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC7E,KAAK,CAAC,MAAM,EAAE,CAAC;QAEf,IAAM,aAAa,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;QACtD,aAAa,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;QACrB,IAAM,MAAM,GAAG,IAAI,MAAM,CAAC;YACtB,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,aAAa;YACxC,MAAM,EAAE,EAAE;YACV,OAAO,EAAE,aAAa;YACtB,MAAM,EAAE;gBACJ,CAAC,EAAE;oBACC,IAAI,EAAE,MAAM;oBACZ,SAAS,EAAE,EAAE;oBACb,IAAI,EAAE,OAAO;iBAChB;aACJ;YACD,eAAe,EAAE;gBACb,IAAI,EAAE,MAAM;aACf;YACD,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC,KAAK;YACrB,GAAG,EAAE,EAAE,CAAC,KAAK,CAAC,GAAG;YACjB,KAAK,EAAE,GAAG;YACV,KAAK,EAAE,IAAI;YACX,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,QAAQ,YAAC,EAAsB;oBAArB,0BAAU,EAAE,sBAAQ;gBAC1B,EAAE,CAAC,QAAQ,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;gBACjC,EAAE,CAAC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;aAChC;SACJ,CAAC,CAAC;QACH,MAAM,CAAC,MAAM,EAAE,CAAC;QAEhB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;KACxB;IAED,qCAAS,GAAT;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC;YAAC,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;QACrC,EAAE,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;YAAC,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;KAC1C;IAED,uCAAW,GAAX,UAAY,OAA6D;QACrE,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC;YACd,IAAI,CAAC,OAAO,EAAE,CAAC;KACtB;IAED,uCAAW,GAAX;QACI,IAAI,CAAC,SAAS,EAAE,CAAC;KACpB;;gBApLJ,SAAS,SAAC;oBACP,QAAQ,EAAE,UAAU;oBACpB,QAAQ,EAAE,8IAGU;oBACpB,MAAM,EAAE,CAAE,uBAAuB,CAAE;oBACnC,eAAe,EAAE,uBAAuB,CAAC,MAAM;iBAClD;;;;gBAXuK,iBAAiB;;;0BAkBpL,KAAK;yBAQL,KAAK;6BACL,KAAK;6BACL,KAAK;2BAEL,KAAK;4BAOL,KAAK;gCAEL,KAAK;yBASL,SAAS,SAAC,WAAW;+BACrB,SAAS,SAAC,QAAQ;;4BAjDvB;;SAYa,iBAAiB","sourcesContent":["import { Component, Input, HostBinding, ViewChild, ElementRef, OnDestroy, OnChanges, SimpleChanges, NgZone, OnInit, TemplateRef, SimpleChange, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';\r\nimport { coerceNumberProperty } from '@angular/cdk/coercion';\r\n\r\n@Component({\r\n    selector: 'timeline',\r\n    template: `\r\n    <ng-container *ngIf=\"_title; else _titleTpl\"><h4>{{_title}}</h4></ng-container>\r\n    <div #container></div>\r\n    <div #slider></div>`,\r\n    styles: [ `:host {display:block}` ],\r\n    changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimelineComponent implements OnDestroy, OnChanges, OnInit {\r\n\r\n    // region: fields\r\n\r\n    _title = '';\r\n    _titleTpl: TemplateRef<any>;\r\n    @Input()\r\n    set title(value: string | TemplateRef<any>) {\r\n        if (value instanceof TemplateRef)\r\n            this._titleTpl = value;\r\n        else\r\n            this._title = value;\r\n    }\r\n\r\n    @Input() data: Array<{ x: Date, y1: number , y2: number, [key: string]: any }>;\r\n    @Input() titleMap: { y1: string , y2: string };\r\n    @Input() colorMap: { y1: string , y2: string } = { y1: '#1890FF', y2: '#2FC25B' };\r\n\r\n    @Input()\r\n    get height() { return this._height; }\r\n    set height(value: any) {\r\n        this._height = coerceNumberProperty(value);\r\n    }\r\n    private _height = 400;\r\n\r\n    @Input() padding: number[] = [60, 20, 40, 40];\r\n\r\n    @Input()\r\n    get borderWidth() { return this._borderWidth; }\r\n    set borderWidth(value: any) {\r\n        this._borderWidth = coerceNumberProperty(value);\r\n    }\r\n    private _borderWidth = 2;\r\n\r\n    // endregion\r\n\r\n    @ViewChild('container') node: ElementRef;\r\n    @ViewChild('slider') sliderNode: ElementRef;\r\n\r\n    chart: any;\r\n    initFlag = false;\r\n    slider: any;\r\n\r\n    constructor(private cd: ChangeDetectorRef) { }\r\n\r\n    ngOnInit(): void {\r\n        this.initFlag = true;\r\n        setTimeout(() => this.install(), 200);\r\n    }\r\n\r\n    install() {\r\n        if (!this.data || (this.data && this.data.length < 1)) return;\r\n\r\n        // clean\r\n        this.sliderNode.nativeElement.innerHTML = '';\r\n        this.node.nativeElement.innerHTML = '';\r\n\r\n        const MAX = 8;\r\n        const begin = this.data.length > MAX ? (this.data.length - MAX) / 2 : 0;\r\n\r\n        const ds = new DataSet({\r\n            state: {\r\n                start: this.data[begin - 1].x,\r\n                end: this.data[begin - 1 + MAX].x\r\n            }\r\n        });\r\n        const dv = ds.createView().source(this.data);\r\n        dv.source(this.data).transform({\r\n            type: 'filter',\r\n            callback(obj) {\r\n                const time = new Date(obj.x).getTime(); // !注意：时间格式，建议转换为时间戳进行比较\r\n                return time >= ds.state.start && time <= ds.state.end;\r\n            }\r\n        });\r\n\r\n        const chart = new G2.Chart({\r\n            container: this.node.nativeElement,\r\n            forceFit: true,\r\n            height: +this.height,\r\n            padding: this.padding\r\n        });\r\n        chart.axis('x', { title: false });\r\n        chart.axis('y1', {\r\n            title: false\r\n        });\r\n        chart.axis('y2', false);\r\n\r\n        let max;\r\n        if (this.data[0] && this.data[0].y1 && this.data[0].y2) {\r\n            max = Math.max(\r\n                this.data.sort((a, b) => b.y1 - a.y1)[0].y1,\r\n                this.data.sort((a, b) => b.y2 - a.y2)[0].y2\r\n            );\r\n        }\r\n        chart.source(dv, {\r\n            x: {\r\n                type: 'timeCat',\r\n                tickCount: MAX,\r\n                mask: 'HH:MM',\r\n                range: [0, 1]\r\n            },\r\n            y1: {\r\n                alias: this.titleMap.y1,\r\n                max,\r\n                min: 0\r\n            },\r\n            y2: {\r\n                alias: this.titleMap.y2,\r\n                max,\r\n                min: 0\r\n            }\r\n        });\r\n\r\n        chart.legend({\r\n            position: 'top',\r\n            custom: true,\r\n            clickable: false,\r\n            items: [\r\n                { value: this.titleMap.y1, fill: this.colorMap.y1 },\r\n                { value: this.titleMap.y2, fill: this.colorMap.y2 }\r\n            ]\r\n        });\r\n\r\n        chart.line().position('x*y1').color(this.colorMap.y1).size(this.borderWidth);\r\n        chart.line().position('x*y2').color(this.colorMap.y2).size(this.borderWidth);\r\n        chart.render();\r\n\r\n        const sliderPadding = Object.assign([], this.padding);\r\n        sliderPadding[0] = 0;\r\n        const slider = new Slider({\r\n            container: this.sliderNode.nativeElement,\r\n            height: 26,\r\n            padding: sliderPadding,\r\n            scales: {\r\n                x: {\r\n                    type: 'time',\r\n                    tickCount: 16,\r\n                    mask: 'HH:MM'\r\n                }\r\n            },\r\n            backgroundChart: {\r\n                type: 'line'\r\n            },\r\n            start: ds.state.start,\r\n            end: ds.state.end,\r\n            xAxis: 'x',\r\n            yAxis: 'y1',\r\n            data: this.data,\r\n            onChange({startValue, endValue}) {\r\n                ds.setState('start', startValue);\r\n                ds.setState('end', endValue);\r\n            }\r\n        });\r\n        slider.render();\r\n\r\n        this.chart = chart;\r\n        this.slider = slider;\r\n    }\r\n\r\n    uninstall() {\r\n        if (this.chart) this.chart.destroy();\r\n        if (this.slider) this.slider.destroy();\r\n    }\r\n\r\n    ngOnChanges(changes: { [P in keyof this]?: SimpleChange } & SimpleChanges): void {\r\n        if (this.initFlag)\r\n            this.install();\r\n    }\r\n\r\n    ngOnDestroy(): void {\r\n        this.uninstall();\r\n    }\r\n}\r\n"]}